name: Security Agent Workflow
# The GitHub Actions workflow requires you to create a secret named COPILOT_GITHUB_TOKEN. This token is a fine-grained personal access token with the Copilot Requests read-only permission. Add this token as a secret in your GitHub repository settings to enable the workflow to authenticate with Copilot.
on:
  push:
    branches: ["main"]
  workflow_dispatch: # Adds the ability to run manually from CLI or

jobs:
  security-assessment:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install GitHub Copilot CLI
        run: npm i -g @github/copilot

      - name: Run Security Agent via Copilot CLI
        env:
          # The CLI often looks for GITHUB_TOKEN or GH_TOKEN specifically
          GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          set -euo pipefail
          mkdir -p security-reports

          # 1. Clean the prompt
          CLEAN_PROMPT=$(sed -n '/^---$/ { :a; n; /^---$/! ba; n; }; p' .github/agents/security-reporter.agent.md)

          # 2. Build the prompt into a file to avoid command line length limits
          cat <<EOF > prompt_content.txt
          $CLEAN_PROMPT

          Context:
          - Repository: $GITHUB_REPOSITORY

          Task:
          - Execute instructions and generate report at security-reports/security-assessment-report.md
          EOF

          # 3. Use 'unbuffer' (from the expect package) to run the CLI
          # This provides a more robust TTY environment than 'script'
          sudo apt-get install -y expect
          
          echo "Starting Copilot Agentic Scan..."
          
          # We use a subshell to read the file into the command
          unbuffer copilot --prompt "$(cat prompt_content.txt)" \
            --allow-all-tools \
            --allow-all-paths \
            --non-interactive 2>&1 | tee copilot_runtime.log

          # Check if the report was actually created
          if [ ! -f "security-reports/security-assessment-report.md" ]; then
            echo "::error::Agent finished but no report was found at the expected path."
            cat copilot_runtime.log
            exit 1
          fi
      - name: Output security report as summary
        if: always()
        run: |
          set -euo pipefail
          REPORT_PATH="security-reports/security-assessment-report.md"

          if [ ! -f "$REPORT_PATH" ]; then
            echo "No security report generated; skipping summary."
            exit 0
          fi

          # Add a header to the summary
          echo "# Security Assessment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Append the full report content
          cat "$REPORT_PATH" >> $GITHUB_STEP_SUMMARY

      - name: Upload security report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-assessment-report-${{ github.run_id }}
          path: security-reports/security-assessment-report.md
          retention-days: 30

      - name: Check for critical vulnerabilities
        if: always()
        run: |
          set -euo pipefail
          REPORT_PATH="security-reports/security-assessment-report.md"

          if [ ! -f "$REPORT_PATH" ]; then
            echo "No security report generated; skipping critical check."
            exit 0
          fi

          if grep -q "THIS ASSESSMENT CONTAINS A CRITICAL VULNERABILITY" "$REPORT_PATH"; then
            echo "❌ CRITICAL VULNERABILITY DETECTED - Workflow failed"
            echo "The security assessment found critical vulnerabilities that must be addressed before proceeding."
            exit 1
          else
            echo "✅ No critical vulnerabilities detected"
          fi
